---
# yamllint disable rule:max-lines
- name: Provision / initialize dom0
  hosts: none
  tasks:
    # Prepare dom0
    # NOTE: The Qubes dom0 provisioning has some "become" sourcery involved because the default
    # user is root instead of the dom0 user
    - name: Check if dom0 was provisioned
      stat:
        path: /tmp/.setup-dom0-partially-provisioned
      register: dom0_partially_provisioned
    - name: Update and configure dom0
      vars:
        dom0_features:
          - dotfiles
          - grub
          - mirage
          - new-menu
          # - opnsense
          - plymouth
          - policy
          - screenshot
          - split-gpg
          - sudo-prompt
          - sys-gui
          - sys-usb
          - theme
          - u2f
          - update
          - yubikey
      include_role:
        name: professormanhattan.qubes
      when: not dom0_partially_provisioned.stat.exists
    - name: Register "partially provisioned" indicator temporary file
      copy:
        content: |
          done
        dest: /tmp/.setup-dom0-partially-provisioned
      when: not dom0_partially_provisioned.stat.exists
    - name: Ensure primary-templates-full TemplateVMs are configured to use sys-firewall as their NetVM
      vars:
        netvm: sys-firewall
      include_tasks: tasks/qubes/connect-netvm.yml
      loop: "{{ groups['primary-templates-full'] }}"
    - name: Check if debian-11-backup was created
      command: qvm-check debian-11-backup
      register: qvm_debian_check
    - name: Clone a backup of debian-11
      command: qvm-clone debian-11 debian-11-backup
      when: qvm_debian_check.rc != 0

- name: Ensure upstream templates are upgraded
  hosts: debian-11-backup
  tasks:
    - name: Determine if RPM Fusion was already enabled
      become: true
      stat:
        path: /root/.setup-rpm-fusion-enabled
      register: template_rpm_fusion
      when: ansible_os_family == 'RedHat'
    - name: Ensure RPM Fusion package repositories are enabled on RedHat-flavored systems
      become: true
      command:
        cmd: |
          dnf config-manager --set-enabled rpmfusion-free
          dnf config-manager --set-enabled rpmfusion-free-updates
          dnf config-manager --set-enabled rpmfusion-nonfree
          dnf config-manager --set-enabled rpmfusion-nonfree-updates
      when:
        - ansible_os_family == 'RedHat'
        - not template_rpm_fusion.stat.exists
    - name: Register RPM Fusion enabled indicator
      become: true
      copy:
        content: |
          done
        dest: /root/.setup-rpm-fusion-enabled
      when:
        - ansible_os_family == 'RedHat'
        - not template_rpm_fusion.stat.exists
    - name: Ensure Debian systems are updated
      become: true
      apt:
        cache_valid_time: 3600
        force_apt_get: true
        update_cache: true
        upgrade: dist
      when: ansible_os_family == 'Debian'
    - name: Ensure RedHat systems are updated
      become: true
      dnf:
        name: '*'
        state: latest
        update_cache: true
      when: ansible_os_family == 'RedHat'
    - name: Ensure Archlinux systems are updated
      become: true
      community.general.pacman:
        update_cache: true
        upgrade: true
      when: ansible_os_family == 'Archlinux'
    - name: Install common software packages
      become: true
      ansible.builtin.package:
        name: "{{ common_software_packages }}"
        state: latest
    - name: Apply full theme and dotfiles
      include_role:
        name: professormanhattan.theme
    - name: Apply just the dotfiles
      include_role:
        name: professormanhattan.dotfiles

- name: Create the VM structure now that the templates are updated
  hosts: dom0
  tasks:
    - name: Ensure primary full TemplateVMs are disconnected from NetVMs
      vars:
        netvm: None
      include_tasks: tasks/qubes/connect-netvm.yml
      loop: "{{ groups['primary-templates-full'] }}"
    - name: Check whether the structure was recently provisioned
      stat:
        path: /tmp/.setup-dom0-fully-provisioned
      register: dom0_fully_provisioned
    - name: Ensure all VMs except sys-net, sys-firewall, sys-whonix, and provision are shutdown
      command: qvm-shutdown --all --exclude=dom0 --exclude=sys-net --exclude=sys-firewall --exclude=sys-whonix --exclude=sys-usb --exclude=sys-gui --exclude=sys-gui-gpu --exclude=sys-gui-vnc --exclude=provision
    - name: Scaffold out the VM structure using Salt (now that all the TemplateVMs are updated)
      vars:
        dom0_features:
          - create-vms
      include_role:
        name: professormanhattan.qubes
      when: not dom0_fully_provisioned.stat.exists
    - name: Register "fully provisioned" indicator temporary file
      copy:
        content: |
          done
        dest: /tmp/.setup-dom0-fully-provisioned
      when: not dom0_fully_provisioned.stat.exists

- name: Provision the primary template VMs
  hosts: vpn-tmpl
  tasks:
    - name: Provision the custom template VM
      include_tasks: tasks/qubes/custom-template-vm.yml
    - name: Configure VMs to forward TCP traffic on certain ports to OPNsense
      vars:
        systemd_services:
          - name: opnsense-http-service
            port: 80
          - name: opnsense-https-service
            port: 443
      include_tasks: tasks/qubes/tcp-port-bind.yml
    - name: Ensure directory for custom Ansible facts exists
      become: true
      ansible.builtin.file:
        state: directory
        recurse: yes
        path: /rw/config/qubes-bind-dirs.d
      when: persistent_docker_volumes | default(false)
    - name: Ensure Docker files are persistent
      copy:
        content: |
          binds+=( '/var/lib/docker' )
          binds+=( '/etc/docker' )
        dest: /rw/config/qubes-bind-dirs.d/50-docker.conf
      when: persistent_docker_volumes | default(false)
    - name: Randomize MAC address and ensure no hostname leaks (Source -> https://github.com/Qubes-Community/Contents/blob/master/docs/privacy/anonymizing-your-mac-address.md)
      include_tasks: tasks/qubes/randomize-mac.yml
      when: randomize_mac_address | default(false)

# Needs StandaloneVM - will build with Packer
# - name: Install Pritunl server to Pritunl TemplateVM
#   hosts: pritunl-server-template
#   tasks:
#     - name: Run the install Pritunl server install script
#       include_tasks: tasks/qubes/pritunl-server.yml

- name: Finish provisioning dom0
  hosts: dom0
  tasks:
    - name: Set the NetVM for all VMs
      include_tasks: tasks/qubes/set-netvm.yml
      loop: "{{ groups['qubes-vms'] }}"
    - name: Enable updates over Tor
      vars:
        dom0_features:
          - tor-updates
      include_role:
        name: professormanhattan.qubes
