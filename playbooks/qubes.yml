---
# yamllint disable rule:max-lines
- name: Provision / initialize dom0
  hosts: dom0
  connection: qubes
  tasks:
    # Prepare dom0
    - name: Update and configure dom0
      vars:
        dom0_features:
          - create-vms
          - dotfiles
          - grub
          - new-menu
          - opnsense
          - plymouth
          - policy
          - split-gpg
          - sudo-prompt
          # - sys-gui
          - sys-usb
          - theme
          # - tor-updates
          - u2f
          - update
          - yubikey
      include_role:
        name: professormanhattan.qubes

- name: Provision the primary template VMs
  hosts: secondarytemplates
  connection: qubes
  tasks:
    - name: Provision the custom template VM
      include_tasks: qubes/tasks/custom-template-vm.yml
    - name: Configure VMs to forward TCP traffic on certain ports to OPNsense
      vars:
        systemd_services:
          - name: opnsense-http-service
            port: 80
          - name: opnsense-https-service
            port: 443
      include_tasks: tasks/qubes/tcp-port-bind.yml

# - name: Ensure the Fedora 36 XFCE4 TemplateVM gets injected with all the theme files
#   hosts: fedora-36-xfce
#   connection: qubes
#   tasks:
#     - name: Ensure VM is configured to be a GUI VM
#       include_tasks: tasks/qubes/gui-vm.yml

- name: Make MAC addresses random (randomized every reboot)
  hosts: debian-11-sys-net-dvm
  connection: qubes
  tasks:
    # Source: https://github.com/Qubes-Community/Contents/blob/master/docs/privacy/anonymizing-your-mac-address.md
    # TODO: Same logic for OPNSense
    - name: Randomize MAC address and ensure no hostname leaks
      include_tasks: tasks/qubes/randomize-mac.yml

# Needs StandaloneVM - will build with Packer
# - name: Install Pritunl server to Pritunl TemplateVM
#   hosts: pritunl-server-template
#   connection: qubes
#   tasks:
#     - name: Run the install Pritunl server install script
#       include_tasks: tasks/qubes/pritunl-server.yml

- name: Configure persistent Docker files in select VMs
  hosts: development:kubernetes:swarm
  connection: qubes
  strategy: free
  tasks:
    - name: Ensure directory for custom Ansible facts exists
      become: true
      ansible.builtin.file:
        state: directory
        recurse: yes
        path: /rw/config/qubes-bind-dirs.d
    - name: Ensure Docker files are persistent
      copy:
        content: |
          binds+=( '/var/lib/docker' )
          binds+=( '/etc/docker' )
        dest: /rw/config/qubes-bind-dirs.d/50-docker.conf
