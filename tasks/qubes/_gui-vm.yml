---
- name: Remove various "ugly" wallpaper assets
  become: true
  file:
    path: '{{ item }}'
    state: absent
  loop:
    - /usr/share/backgrounds/images
    - /usr/share/backgrounds/f32
    - /usr/share/backgrounds/qubes
    - /usr/share/backgrounds/xfce
    - /usr/share/wallpapers

- name: Ensure {{ theme_slug }} theme source is available
  become: true
  ansible.builtin.git:
    repo: https://gitlab.com/megabyte-labs/linux-theme.git
    dest: /usr/src/{{ theme_slug }}
    clone: true
    update: true
  register: linux_theme

- name: Copy over theme files
  become: true
  copy:
    src: /usr/src/{{ theme_slug }}/share/
    dest: /usr/share/
    remote_src: true
  when: linux_theme.changed

- name: Ensure /usr/share/plasma uses files instead of symlinks
  become: true
  shell:
    cmd: |
      set -ex
      while read link; do
        test -h "$link" || continue
        dir=$(dirname "$link")
        reltarget=$(readlink "$link")
        case $reltarget in
            /*) abstarget=$reltarget;;
            *)  abstarget=$dir/$reltarget;;
        esac
        rm -fv "$link"
        cp -afv "$abstarget" "$link" || {
            # on failure, restore the symlink
            rm -rfv "$link"
            ln -sfv "$reltarget" "$link"
        }
      done< <(find /usr/share/plasma -type l)
  register: squash_symlink
  changed_when: "squash_symlink.stdout != ''"
  when: linux_theme.changed
  args:
    executable: /bin/bash

- name: Ensure package dependencies are installed
  become: true
  ansible.builtin.package:
    name:
      - kde-plasma-desktop
      - kdeplasma-addons
      - kvantum
      - rofi
    state: latest

- name: Ensure ~/.config/user-kde-settings is a folder
  file:
    path: ~/.config/user-kde-settings
    state: directory
    recurse: true

- name: Ensure user theme backup gets applied
  copy:
    src: files/user-kde-settings.tar.gz
    dest: ~/.config/user-kde-settings.tar.gz
  register: user_kde_copy
  args:
    creates: ~/.config/user-kde-settings.tar.gz

- name: Decompress the user-kde-settings.tar.gz file
  ansible.builtin.unarchive:
    src: ~/.config/user-kde-settings.tar.gz
    dest: ~/.config/user-kde-settings
  when: user_kde_copy.changed

- name: Ensure ~/.config/plasma is a folder
  file:
    path: ~/.local/plasma
    state: directory
    recurse: true
  when: user_kde_copy.changed

- name: Move user theme plasma/plasmoids folder
  copy:
    src: ~/.config/user-kde-settings/plasma/
    dest: ~/.local/plasma/
    remote_src: true
  when: user_kde_copy.changed

- name: Remove user-kde-settings plasma folder
  file:
    path: ~/.config/user-kde-settings/plasma
    state: absent
  when: user_kde_copy.changed

- name: Copy over other files in the user-kde-settings to ~/.config
  copy:
    src: ~/.config/user-kde-settings/
    dest: ~/.config/
    remote_src: true
  when: user_kde_copy.changed

- name: Add the dotfiles
  include_tasks: dotfiles.yml

- name: Ensure /usr/share/applications has a hidden folder
  become: true
  file:
    path: /usr/share/applications/hidden
    state: directory

- name: Remove unnecessary System Tools
  include_tasks: remove-shortcut.yml
  loop: '{{ hidden_system_tools }}'

- name: Ensure Kvantum has environment variable set
  become: true
  lineinfile:
    path: /etc/environment
    regex: QT_STYLE_OVERRIDE
    line: export QT_STYLE_OVERRIDE=kvantum

- name: Apply gsettings
  include_tasks: gsetting.yml
  loop:
    # Enables CTRL+Shift+I to inspect Gtk options
    - setting: org.gtk.Settings.Debug enable-inspector-keybinding
      value: 'true'
    - setting: org.gnome.desktop.interface gtk-theme
      value: Sweet
    - setting: org.gnome.desktop.wm.preferences theme
      value: Sweet
# TODO Move to role
# - name: Update xfconf settings
#   community.general.system.xfconf:
#     channel: "{{ item.channel }}"
#     property: "{{ item.property }}"
#     value_type: "{{ item.value_type | default('string') }}"
#     value: "{{ item.value }}"
#   failed_when: false
#   loop: "{{ qubes_xfconf_settings }}"
