---
- name: Check whether the structure was recently provisioned
  stat:
    path: /tmp/.setup-dom0-{{ formation_slug }}
  register: phase_fully_provisioned

- name: Ensure all VMs except sys-net, sys-firewall, sys-whonix, and provision are shutdown
  command: qvm-shutdown --all --wait --exclude=dom0 --exclude=sys-net --exclude=sys-firewall --exclude=sys-usb --exclude=sys-gui --exclude=sys-gui-gpu --exclude=sys-gui-vnc --exclude=provision

- name: Debug
  debug:
    msg: "{{ formation_slug }}"

- name: Debug
  debug:
    msg: "{{ formation }}"

- name: Apply the formation
  vars:
    dom0_features:
      - create-vms
  include_role:
    name: professormanhattan.qubes
  when: not phase_fully_provisioned.stat.exists

- name: Ensure the new VMs have access to sys-firewall so they can be provisioned
  vars:
    netvm: sys-firewall
  include_tasks: tasks/qubes/qvm-netvm.yml
  loop: "{{ formation | difference(formation_previous | default([])) }}"

- name: Register "fully provisioned" indicator temporary file
  copy:
    content: |
      done
    dest: /tmp/.setup-dom0-{{ formation_slug }}
  when: not phase_fully_provisioned.stat.exists
