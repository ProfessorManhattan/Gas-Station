---
- name: Fix for known snap issue
  command: snap --version &> /dev/null
  changed_when: false
  failed_when: false

- name: Provision the custom TemplateVMs
  include_role:
    name: '{{ role }}'
  loop: '{{ qubes_roles[inventory_hostname] | default([]) }}'
  loop_control:
    label: '{{ inventory_hostname }}'
    loop_var: role

- name: Install software packages using the generic installer
  vars:
    software: "{{ qubes_software[inventory_hostname] | default('') }}"
  include_role:
    name: roles/helpers/installer
  when: qubes_software[inventory_hostname] is defined

- name: Run the finishing role(s) on the TemplateVMs
  include_role:
    name: '{{ role }}'
  loop:
    - roles/system/finish
  loop_control:
    label: '{{ inventory_hostname }}'
    loop_var: role
