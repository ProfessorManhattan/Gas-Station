---
# - name: Clone the VM-lockdown repository
#   become: true
#   ansible.builtin.git:
#     repo: https://github.com/tasket/Qubes-VM-hardening.git
#     dest: /usr/src/hardening
#
# - name: Run the installer
#   become: true
#   command: |
#     bash install
#     bash configure-sudo-prompt --force
#   args:
#     chdir: /usr/src/hardening
#     creates: /lib/systemd/system/vm-boot-protect.service

- name: Ensure qubes-gpg-split and qubes-u2f are installed
  become: true
  ansible.builtin.package:
    name:
      - qubes-gpg-split
      - qubes-u2f
    state: latest

- name: Ensure all the common roles are applied to the custom TemplateVMs
  include_role:
    name: '{{ role }}'
  loop:
    # - roles/system/dns # Goes wherever DNS resolver is pending Qubes Forum answer
    - roles/services/antivirus
    - roles/services/elasticagent
    - roles/services/portmaster
    - roles/services/wazuh
    - roles/applications/tabby
  loop_control:
    label: '{{ inventory_hostname }}'
    loop_var: role

- name: Provision the custom TemplateVMs
  include_role:
    name: '{{ role }}'
  loop: '{{ qubes_roles[inventory_hostname] | default([]) }}'
  loop_control:
    label: '{{ inventory_hostname }}'
    loop_var: role

- name: Run the finishing role(s) on the TemplateVMs
  include_role:
    name: '{{ role }}'
  loop:
    - roles/system/finish
  loop_control:
    label: '{{ inventory_hostname }}'
    loop_var: role

- name: Ensure default application launchers are configured to use DVMs
  include_tasks: tasks/qubes/preferred-app.yml
  loop: '{{ mimetype_handlers }}'

- name: Configure VMs to forward TCP traffic on certain ports to OPNsense
  vars:
    systemd_services:
      - name: opnsense-http-service
        port: 80
      - name: opnsense-https-service
        port: 443
  include_tasks: tcp-port-bind.yml
