---
- name: Ensure "untrusted" binary assets are available
  vars:
    file_name: firacode.tar.gz
  include_tasks: untrusted-download.yml

- name: Unpack the firacode.tar.gz file to /usr/share/backgrounds/images
  become: true
  unarchive:
    src: /usr/src/qubes-dom0-binaries/firacode.tar.gz
    dest: /usr/share/fonts/firacode
    extra_opts:
      - --strip-components=1
    remote_src: true

- name: Ensure "untrusted" binary assets are available
  vars:
    file_name: flat-remix-gtk-master.tar.gz
  include_tasks: untrusted-download.yml

- name: Unpack the flat-remix-gtk-master.tar.gz file to /usr/src/flat-remix-gtk
  become: true
  unarchive:
    src: /usr/src/qubes-dom0-binaries/flat-remix-gtk-master.tar.gz
    dest: /usr/src/flat-remix-gtk
    extra_opts:
      - --strip-components=1
    remote_src: true

- name: Copy themes from /usr/src/flat-remix-gtk
  copy:
    src: /usr/src/flat-remix-gtk/themes/{{ item }}
    dest: /usr/share/themes/{{ item }}
  loop:
    - Flat-Remix-Light-XFWM
    - Flat-Remix-GTK-Blue-Light-Solid

- name: Ensure "untrusted" binary assets are available
  vars:
    file_name: simp1e-tokyo-night.tar.gz
  include_tasks: untrusted-download.yml

- name: Unpack the simp1e-tokyo-night.tar.gz file to /usr/share/icons/tokyo-night-cursor-theme
  become: true
  unarchive:
    src: /usr/src/qubes-dom0-binaries/simp1e-tokyo-night.tar.gz
    dest: /usr/share/icons/tokyo-night-cursor-theme
    extra_opts:
      - --strip-components=1
    remote_src: true

- name: Ensure dependencies are installed
  include_tasks: dependency.yml
  loop:
    - @kde-desktop-qubes
    - flat-remix-icon-theme
    - glib2-devel
    - gnome-shell
    - ImageMagick
    - qt5ct
    - xfce4-clipman-plugin
    - xfce4-embed-plugin
    - xfce4-whiskermenu-plugin
    - xfce4-mpc-plugin
    - xfce4-netload-plugin
    - xfce4-notes-plugin
    - xfce4-statusnotifier-plugin
    - xfce4-weather-plugin

- name: Ensure "untrusted" binary assets are available
  vars:
    file_name: flat-remix-gnome-20210118.tar.gz
  include_tasks: untrusted-download.yml

- name: Unpack the flat-remix-gnome-20210118.tar.gz file to /usr/src/flat-remix-gnome
  become: true
  unarchive:
    src: /usr/src/qubes-dom0-binaries/flat-remix-gnome-20210118.tar.gz
    dest: /usr/src/flat-remix-gnome
    extra_opts:
      - --strip-components=1
    remote_src: true

- name: Run make && sudo make install in the flat-remix-gnome src folder
  command: make && sudo make install
  args:
    chdir: /usr/src/flat-remix-gnome
    creates: /usr/src/flat-remix-gnome/build

- name: Clean up unnecessary System Tools links
  become: true
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /usr/share/applications/xfce4-terminal-settings.desktop
    - /usr/share/applications/xterm.desktop
    - /usr/share/applications/xfce-wmtweaks-settings.desktop
    - /usr/share/applications/xfce-workspaces-settings.desktop
    - /usr/share/applications/xfce4-sensors.desktop
    - /usr/share/applications/panel-preferences.desktop
    - /usr/share/applications/org.gnome.PackageUpdater.desktop
    - /usr/share/applications/exo-file-manager.desktop
    - /usr/share/applications/thunar-bulk-rename.desktop
    - /usr/share/applications/thunar-settings.desktop
    - /usr/share/applications/xfce4-appfinder.desktop
    - /usr/share/applications/xfce4-about.desktop
    - /usr/share/applications/xfce4-accessibility-settings.desktop

- name: Update xfconf settings
  xfconf:
    channel: "{{ item.channel }}"
    property: "{{ item.property }}"
    value_type: "{{ item.value_type | default('string') }}"
    value: "{{ item.value }}"
  loop:
    - channel: xfwm4
      property: /general/theme
      value: Flat-Remix-Light-XFWM
    - channel: xfwm4
      property: /general/title_font
      value: Montserrat Ultra-Bold 10
    - channel: xfwm4
      property: /general/title_alignment
      value: left
    - channel: xsettings
      property: /Net/ThemeName
      value: Flat-Remix-GTK-Blue-Light-Solid
    - channel: xsettings
      property: /Gtk/MonospaceFontName
      value: Nimbus Mono PS 11
    - channel: xsettings
      property: /Gtk/FontName
      value: System-ui 10
    - channel: xsettings
      property: /Xfce/LastCustomDPI
      value: 100
      value_type: int
    - channel: xsettings
      property: /Xft/DPI
      value: 100
      value_type: int
    - channel: xfce4-power-manager
      property: /xfce4-power-manager/blank-on-ac
      value: 30
      value_type: int
    - channel: xfce4-power-manager
      property: /xfce4-power-manager/dpms-on-ac-off
      value: 60
      value_type: int
    - channel: xfce4-power-manager
      property: /xfce4-power-manager/hibernate-button-action
      value: 2
      value_type: int
    - channel: xfce4-power-manager
      property: /xfce4-power-manager/sleep-button-action
      value: 1
      value_type: int
    - channel: xfce4-power-manager
      property: /xfce4-power-manager/battery-button-action
      value: 3
      value_type: int
    - channel: xfce4-power-manager
      property: /xfce4-power-manager/power-button-action
      value: 4
      value_type: int
    - channel: xfce4-power-manager
      property: /xfce4-power-manager/general-notification
      value: true
      value_type: boolean
    - channel: xfce4-desktop
      property: /backdrop/screen0/monitorDP-2/workspace0/last-image
      value: /usr/share/backgrounds/images/aurora-stars.jpg
    - channel: xfce4-desktop
      property: /backdrop/screen0/monitorDP-2/workspace1/last-image
      value: /usr/share/backgrounds/images/blue-butter-flies.jpg
    - channel: xfce4-desktop
      property: /backdrop/screen0/monitorDP-2/workspace2/last-image
      value: /usr/share/backgrounds/images/underwater-turtle.jpg
    - channel: xfce4-desktop
      property: /backdrop/screen0/monitorDP-2/workspace3/last-image
      value: /usr/share/backgrounds/images/colorful-jellyfish.jpg
    - channel: xfce4-desktop
      property: /backdrop/screen0/monitor0/workspace0/last-image
      value: /usr/share/backgrounds/images/aurora-stars.jpg
    - channel: xfce4-desktop
      property: /backdrop/screen0/monitor0/workspace1/last-image
      value: /usr/share/backgrounds/images/blue-butter-flies.jpg
    - channel: xfce4-desktop
      property: /backdrop/screen0/monitor0/workspace2/last-image
      value: /usr/share/backgrounds/images/underwater-turtle.jpg
    - channel: xfce4-desktop
      property: /backdrop/screen0/monitor0/workspace3/last-image
      value: /usr/share/backgrounds/images/colorful-jellyfish.jpg
    - channel: xfce4-session
      property: /compat/LaunchGNOME
      value: true
      value_type: boolean
    - channel: xfce4-session
      property: /security/EnableTcp
      value: true
      value_type: boolean
    - channel: xfce4-panel
      property: /panels/panel-1/icon-size
      value: 28
      value_type: int
    - channel: xfce4-panel
      property: /panels/panel-1/leave-opacity
      value: 92
      value_type: int
    - channel: xfce4-panel
      property: /panels/panel-1/enter-opacity
      value: 100
      value_type: int
    - channel: xfce4-panel
      property: /panels/panel-1/size
      value: 37
      value_type: int
    - channel: xfce4-panel
      property: /plugins/plugin-5/mode
      value: 5
      value_type: int
    - channel: xfce4-panel
      property: /plugins/plugin-5/show-military
      value: true
      value_type: boolean
    - channel: xfce4-panel
      property: /plugins/plugin-5/show-seconds
      value: true
      value_type: boolean
    - channel: xfce4-panel
      property: /plugins/plugin-5/timezone
      value: America/New_York
    - channel: xfce4-panel
      property: /panels/panel-2/size
      value: 67
      value_type: int
    - channel: xfce4-panel
      property: /panels/panel-2/position-locked
      value: true
      value_type: boolean
    - channel: xfce4-panel
      property: /panels/panel-2/position
      value: p=12;x=1783;y=1406
    - channel: xfce4-panel
      property: /panels/panel-2/autohide-behavior
      value: 2
      value_type: int
    - channel: xfce4-panel
      property: /plugins/plugin-6/size-max
      value: 32
      value_type: int
    - channel: xfce4-panel
      property: /plugins/plugin-6/square-icons
      value: true
      value_type: boolean
    - channel: xfce4-panel
      property: /plugins/plugin-6/names-hidden
      value:
        - xfce4-power-manager
        - qui-disk-space
      value_type: array
    - channel: xfce4-panel
      property: /plugins/plugin-1/button-icon
      value: appvm-blue
    - channel: xfce4-panel
      property: /plugins/plugin-1/custom-menu
      value: true
      value_type: boolean
    - channel: xfce4-panel
      property: /plugins/plugin-3/include-all-workspaces
      value: true
      value_type: boolean
    - channel: xfce4-panel
      property: /plugins/plugin-3/grouping
      value: 1
      value_type: int

- name: Ensure SDDM configuration is in place
  copy:
    content: |
      [XDisplay]
      ServerArguments=-nolisten tcp -background none
    path: /etc/sddm.conf

- name: Stop the lightdm service
  ansible.builtin.systemd:
    name: lightdm
    enabled: false
    state: stopped

- name: Enable the SDDM service
  ansible.builtin.systemd:
    state: started
    name: sddm
    enabled: true
