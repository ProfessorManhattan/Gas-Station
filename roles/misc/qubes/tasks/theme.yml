---
- name: Check for presence of theme archive
  stat:
    path: /usr/src/gas-theme
  register: gas_theme_tmp

- name: Download the git repository asset
  shell:
    cmd: |
      qvm-create --label red --template debian-11 provision || EXIT_CODE=$?
      qvm-run provision 'curl -sSL {{ linux_theme_package }} > /home/user/share.tar.gz'
      qvm-run --pass-io provision 'cat /home/user/share.tar.gz' > "/tmp/gas-theme.tar.gz"
  when: not gas_theme_tmp.stat.exists

- name: Ensure /usr/src/gas-theme is a directory
  become: true
  file:
    path: /usr/src/gas-theme
    state: directory

- name: Ensure latest Linux theme files are present on system
  become: true
  ansible.builtin.unarchive:
    src: /tmp/gas-theme.tar.gz
    dest: /usr/src/gas-theme
    extra_opts: [--strip-components=1]
    remote_src: true
  when: not gas_theme_tmp.stat.exists

- name: Remove various "ugly" wallpaper assets
  become: true
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /usr/src/backgrounds/images
    - /usr/src/backgrounds/f32
    - /usr/src/backgrounds/qubes
    - /usr/src/backgrounds/xfce
    - /usr/src/wallpapers

- name: Copy over theme files
  become: true
  copy:
    src: /usr/src/gas-theme/share/
    dest: /usr/share/
    remote_src: true

- name: Ensure /usr/share/plasma uses files instead of symlinks
  become: true
  shell:
    cmd: |
      set -e
      function squashSymlink() {
        for link; do
          test -h "$link" || continue

          dir=$(dirname "$link")
          reltarget=$(readlink "$link")
          case $reltarget in
              /*) abstarget=$reltarget;;
              *)  abstarget=$dir/$reltarget;;
          esac

          rm -fv "$link"
          cp -afv "$abstarget" "$link" || {
              # on failure, restore the symlink
              rm -rfv "$link"
              ln -sfv "$reltarget" "$link"
          }
        done
      }
      find /usr/share/plasma -type l -exec squashSymlink {} +
  register: squash_symlink
  changed_when: "squash_symlink.stdout != ''"

- name: Ensure dependencies are installed
  include_tasks: dependency.yml
  loop:
    - kde-settings-qubes
    - kdeplasma-addons
    # Installed because it integrates with KDE (it's optional)
    - konsole
    # Allows use of more than one monitor (Source: https://forum.qubes-os.org/t/installing-and-running-kde-as-desktop-environment/1513/34?page=2)
    - kscreen
    - kvantum
    - qubes-repo-contrib

- name: Ensure /usr/src/gas-plasmoids is a directory
  become: true
  file:
    path: /usr/src/gas-plasmoids
    state: directory

- name: Install Plasmoids
  include_tasks: plasmoid.yml
  loop: "{{ lookup('fileglob', 'files/plasmoids/*', wantlist=True) }}"

- name: Ensure qubes-repo-contrib packages are installed
  include_tasks: dependency.yml
  loop:
    - rofi

- name: Add the dotfiles
  include_tasks: dotfiles.yml

- name: Ensure /usr/share/applications has a hidden folder
  become: true
  file:
    path: /usr/share/applications/hidden
    state: directory

- name: Remove unnecessary System Tools
  include_tasks: remove-system-tool.yml
  loop: "{{ hidden_system_tools }}"

- name: Ensure Kvantum has environment variable set
  become: true
  lineinfile:
    path: /etc/environment
    regex: "QT_STYLE_OVERRIDE"
    line: "export QT_STYLE_OVERRIDE=kvantum"

- name: Use the Sweet Kvantum theme
  shell:
    cmd: kvantummanager --set Sweet
  # TODO: This is oddly returning an RC of -6 -- no idea why because it works from the terminal with RC 0
  failed_when: false
  args:
    executable: /bin/bash

- name: Apply gsettings
  include_tasks: gsetting.yml
  loop:
    # Enables CTRL+Shift+I to inspect Gtk options
    - setting: org.gtk.Settings.Debug enable-inspector-keybinding
      value: 'true'
    - setting: org.gnome.desktop.interface gtk-theme
      value: 'Sweet'
    - setting: org.gnome.desktop.wm.preferences theme
      value: 'Sweet'

- name: Ensure Sweet KDE look-and-feel is applied
  shell:
    cmd: lookandfeeltool -a Sweet
  args:
    executable: /bin/bash

- name: Ensure the Betelgeuse desktop background is applied
  shell:
    cmd: |
      qdbus org.kde.plasmashell /PlasmaShell org.kde.PlasmaShell.evaluateScript 'var allDesktops = desktops();print (allDesktops);for (i=0;i<allDesktops.length;i++) {d = allDesktops[i];d.wallpaperPlugin = "org.kde.image";d.currentConfigGroup = Array("Wallpaper", "org.kde.image", "General");d.writeConfig("Image", "file:///usr/share/backgrounds/images/default.png")}'

- name: Update xfconf settings
  xfconf:
    channel: "{{ item.channel }}"
    property: "{{ item.property }}"
    value_type: "{{ item.value_type | default('string') }}"
    value: "{{ item.value }}"
  failed_when: false
  loop: "{{ qubes_xfconf_settings }}"

- name: Ensure SDDM configuration is in place
  become: true
  lineinfile:
    path: /etc/sddm.conf
    regex: "#ServerArguments"
    line: "ServerArguments=-nolisten tcp -background none"

- name: Ensure SDDM configuration is in place
  become: true
  lineinfile:
    path: /etc/sddm.conf
    regex: "Current="
    line: "Current=Sweet"

- name: Stop / disable the lightdm service
  become: true
  ansible.builtin.systemd:
    name: lightdm
    enabled: false
    state: stopped

- name: Start / enable the SDDM service
  become: true
  ansible.builtin.systemd:
    state: started
    name: sddm
    enabled: true
