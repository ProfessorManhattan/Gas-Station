---
- name: Check if the wallpapers.tar.gz file is present
  stat:
    path: ~/wallpapers.tar.gz
  register: wallpapers_check

- name: Download the desktop wallpaper repository
  command: |
    qvm-remove --force wallpaper-downloader &> /dev/null || EXIT_CODE=$?
    qvm-create --label red --template debian-11 wallpaper-downloader
    qvm-run wallpaper-downloader "curl -sSL {{ qubes_wallpaper_repo }} > /home/user/wallpapers.tar.gz"
    qvm-run --pass-io wallpaper-downloader 'cat /home/user/wallpapers.tar.gz' > "$HOME/wallpapers.tar.gz"
    qvm-remove --force wallpaper-downloader-downloader &> /dev/null || EXIT_CODE=$?
  when: not (wallpapers_check.stat.exists | default(false))

- name: Remove the current /usr/share/backgrounds/images folder
  become: true
  file:
    path: /usr/share/backgrounds/images
    state: absent

- name: Unpack the wallpapers.tar.gz file to /usr/share/backgrounds/images
  become: true
  unarchive:
    src: ~/wallpapers.tar.gz
    dest: /usr/share/backgrounds/images
    extra_opts:
      - --strip-components=1
    remote_src: true

- name: Remove the ~/wallpapers.tar.gz file
  file:
    path: ~/wallpapers.tar.gz
    state: absent

- name: Remove the README.md from /usr/share/backgrounds/images
  become: true
  file:
    path: /usr/share/backgrounds/images/README.md
    state: absent
