---
- name: Ensure Betelgeuse theme is present
  include_tasks: betelgeuse.yml

- name: Copy over Plymouth theme files
  become: true
  copy:
    src: /usr/src/{{ theme_slug }}/share/plymouth/themes/
    dest: /usr/share/plymouth/themes/
    remote_src: true

- name: Register the Plymouth theme
  become: true
  community.general.system.alternatives:
    name: default.plymouth
    link: /usr/share/plymouth/themes/default.plymouth
    path: /usr/share/plymouth/themes/{{ theme_slug }}/{{ theme_slug }}.plymouth
    priority: 100
  register: plymouth_alternative

- name: Set the Plymouth theme
  become: true
  shell: plymouth-set-default-theme -R {{ theme_slug }}
  register: plymouth_set_default
  failed_when:
    - plymouth_set_default.rc != 0
    - "'sys/power/resume: No such file' not in plymouth_set_default.stderr"
  notify: update initramfs
  when: plymouth_alternative.changed
