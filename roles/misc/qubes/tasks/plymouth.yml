---
- name: Check for presence of theme archive
  stat:
    path: /usr/src/gas-theme
  register: gas_theme_tmp

- name: Download the git repository asset
  shell:
    cmd: |
      qvm-create --label red --template debian-11-dvm download-vm || EXIT_CODE=$?
      qvm-run download-vm 'curl -sSL {{ linux_theme_package }} > /home/user/plymouth.tar.gz'
      qvm-run --pass-io download-vm 'cat /home/user/plymouth.tar.gz' > "/tmp/gas-theme.tar.gz"
  when: not gas_theme_tmp.stat.exists

- name: Ensure /usr/src/gas-theme is a directory
  become: true
  file:
    path: /usr/src/gas-theme
    state: directory

- name: Ensure latest Plymouth theme files are present on system
  become: true
  ansible.builtin.unarchive:
    src: /tmp/gas-theme.tar.gz
    dest: /usr/src/gas-theme
    extra_opts: [--strip-components=1]
    remote_src: true

- name: Copy over Plymouth theme files
  become: true
  copy:
    src: /usr/src/gas-theme/share/plymouth/themes/
    dest: /usr/share/plymouth/themes/
    remote_src: true

- name: Register the Plymouth theme
  become: true
  alternatives:
    name: default.plymouth
    link: /usr/share/plymouth/themes/default.plymouth
    path: /usr/share/plymouth/themes/betelgeuse/betelgeuse.plymouth
    priority: 100

- name: Set the Plymouth theme
  become: true
  shell: plymouth-set-default-theme -R betelgeuse
  notify: update initramfs
