---
- name: Check for presence of theme archive in /tmp
  stat:
    path: /tmp/gas-theme.tar.gz
  register: gas_theme_tmp

- name: Download the git repository asset
  shell:
    cmd: |
      qvm-create --label red --template debian-11 download-vm || EXIT_CODE=$?
      qvm-run download-vm 'curl -sSL {{ linux_theme_package }} > /home/user/plymouth.tar.gz'
      qvm-run --pass-io download-vm 'cat /home/user/plymouth.tar.gz' > "/tmp/gas-theme.tar.gz"
  when: not gas_theme_tmp.stat.exists

- name: Ensure latest Plymouth theme files are present on system
  become: true
  ansible.builtin.unarchive:
    src: /tmp/gas-theme.tar.gz
    dest: /usr/share
    extra_opts: [--strip-components=1]
    remote_src: true

- name: Register the Plymouth theme
  become: true
  alternatives:
    name: default.plymouth
    link: /usr/share/plymouth/themes/default.plymouth
    path: /usr/share/plymouth/themes/polaroid/polaroid.plymouth"
    priority: 100

- name: Set the Plymouth theme
  become: true
  shell: plymouth-set-default-theme polaroid
  notify: update initramfs
