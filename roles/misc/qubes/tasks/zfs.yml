---
# Source: https://github.com/Qubes-Community/Contents/blob/master/docs/configuration/zfs.md
# Source: https://openzfs.github.io/openzfs-docs/Getting%20Started/Fedora/index.html
- name: Determine whether the ZFS RPM file is already present
  stat:
    path: ~/zfs.noarch.rpm
  register: zfs_rpm_check

- name: Download ZFS RPM using temporary Qube
  command: |
    qvm-remove --force zfs-downloader &> /dev/null || EXIT_CODE=$?
    qvm-create --label red --template debian-11 zfs-downloader
    qvm-run zfs-downloader "curl -sSL https://zfsonlinux.org/fedora/zfs-release-2-2$(rpm --eval "%{dist}").noarch.rpm > /home/user/zfs.noarch.rpm"
    qvm-run --pass-io zfs-downloader 'cat /home/user/zfs.noarch.rpm' > "$HOME/zfs.noarch.rpm"
    qvm-remove --force zfs-downloader &> /dev/null || EXIT_CODE=$?
  when: not (zfs_rpm_check.stat.exists | default(false))

- name: Install ZFS
  become: true
  ansible.builtin.yum:
    name: ~/zfs.noarch.rpm
    state: present

- name: Remove ZFS RPM file from user's HOME directory
  file:
    path: ~/zfs.noarch.rpm
    state: absent

# TODO: Determine if this line is necessary:
# sudo sed -i 's/$releasever/18/g' /etc/yum.repo.d/zfs.repo

- name: Determine if @development-tools is already installed
  become: true
  command: dnf search @development-tools
  changed_when: false
  register: dnf_search_devtools

- name: Ensure @development-tools is installed
  become: true
  command: qubes-dom0-update -y @development-tools
  when: 'No matches found.' in dnf_search_devtools.stdout

- name: Determine if zfs is already installed
  become: true
  command: dnf search zfs
  changed_when: false
  register: dnf_search_zfs

- name: Ensure zfs is installed
  become: true
  command: qubes-dom0-update -y zfs
  when: 'No matches found.' in dnf_search_zfs.stdout

- name: Automatically load ZFS modules
  become: true
  copy:
    content: |
      #!/bin/sh

      for module in spl zfs; do
        modprobe ${module} >/dev/null 2>&1
      done
    mode: 0755
    dest: /etc/sysconfig/modules/zfs.modules

# TODO: Add rest of this guide: https://github.com/Qubes-Community/Contents/blob/master/docs/configuration/zfs.md
# TODO: Figure out optimal settings
