---
- name: Create search options for {{ item.package | default(item) }}
  set_fact:
    dnf_search_options: " --exclude {{ item.excludes }}"
  when: item.excludes is defined

- name: Determine if {{ item.package | default(item) }} is already installed
  become: true
  command: dnf search {{ item.package | default(item) }}
  changed_when: false
  register: dependency_dnf_search
  when: item.excludes is not defined

- name: Determine if {{ item.package | default(item) }} is already installed (with search options)
  become: true
  command: dnf search {{ item.package | default(item) }}{{ dnf_search_options | default(omit) }}
  changed_when: false
  register: dependency_dnf_search_alt
  when: item.excludes is defined

- name: Ensure {{ item.package | default(item) }} is installed
  become: true
  command: qubes-dom0-update -y {{ item.package | default(item) }}
  when: "((dependency_dnf_search.stderr is defined) and ('No matches found.' in dependency_dnf_search.stderr)) or ((dependency_dnf_search_alt.stderr is defined) and ('No matches found.' in dependency_dnf_search_alt.stderr))"
