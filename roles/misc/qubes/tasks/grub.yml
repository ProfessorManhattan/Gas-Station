---
- name: Ensure Betelgeuse theme is present
  include_tasks: betelgeuse.yml

- name: Copy over GRUB theme files
  become: true
  copy:
    src: /usr/src/{{ theme_slug }}/share/grub/themes/
    dest: /usr/share/grub/themes/
    remote_src: true

- name: Ensure /boot/grub2/themes is a directory
  become: true
  file:
    path: /boot/grub2
    state: directory

- name: Copy /usr/share/grub/themes to /boot/grub2/themes
  become: true
  copy:
    src: /usr/share/grub/themes/
    dest: /boot/grub2/themes/
    remote_src: true

- name: Optimize the GRUB resolution
  become: true
  lineinfile:
    path: /etc/default/grub
    regex: 'GRUB_GFXMODE='
    line: 'GRUB_GFXMODE={{ qubes_grub_gfxmode }}'
  notify: update grub

- name: Ensure GRUB_GFXPAYLOAD_LINUX is set
  become: true
  lineinfile:
    path: /etc/default/grub
    regex: 'GRUB_GFXPAYLOAD_LINUX='
    line: 'GRUB_GFXPAYLOAD_LINUX="keep"'
  notify: update grub

- name: Ensure GRUB is using the Mirage theme
  become: true
  lineinfile:
    path: /etc/default/grub
    regex: 'GRUB_THEME='
    line: 'GRUB_THEME="/boot/grub2/themes/{{ theme_slug_uppercase }}/theme.txt"'
  notify: update grub

- name: Register the stdout of /etc/default/grub
  command: cat /etc/default/grub
  register: cat_default_grub
  changed_when: false

- name: Generate version of /etc/default/grub that has no duplicate lines
  shell:
    cmd: cat /etc/default/grub | uniq -u
  register: uniq_default_grub
  changed_when: false

- name: Ensure there are no duplicate lines in /etc/default/grub
  become: true
  copy:
    dest: /etc/default/grub
    content: |
      {{ uniq_default_grub.stdout }}
    mode: 0644
  when: cat_default_grub.stdout != uniq_default_grub.stdout

- name: Ensure grubenv is available in the Qubes EFI folder
  become: true
  copy:
    src: /boot/grub2/grubenv
    dest: /boot/efi/EFI/qubes/grubenv
    mode: 0644
    remote_src: true
