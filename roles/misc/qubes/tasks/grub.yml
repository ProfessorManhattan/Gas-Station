---
- name: Check for presence of theme archive
  stat:
    path: /usr/src/gas-theme
  register: gas_theme_tmp

- name: Download the git repository asset
  shell:
    cmd: |
      qvm-create --label red --template debian-11 download-vm || EXIT_CODE=$?
      qvm-run download-vm 'curl -sSL {{ linux_theme_package }} > /home/user/grub.tar.gz'
      qvm-run --pass-io download-vm 'cat /home/user/grub.tar.gz' > "/tmp/gas-theme.tar.gz"
  when: not gas_theme_tmp.stat.exists

- name: Ensure /usr/src/gas-theme is a directory
  become: true
  file:
    path: /usr/src/gas-theme
    state: directory

- name: Ensure latest GRUB theme files are present on system
  become: true
  ansible.builtin.unarchive:
    src: /tmp/gas-theme.tar.gz
    dest: /usr/src/gas-theme
    extra_opts: [--strip-components=1]
    remote_src: true

- name: Copy over GRUB theme files
  become: true
  copy:
    src: /usr/src/gas-theme/share/grub/themes/
    dest: /usr/share/grub/themes/
    remote_src: true

- name: Ensure /boot/grub2/themes is a directory
  become: true
  file:
    path: /boot/grub2/themes
    state: directory

- name: Copy /usr/share/grub/themes/Mirage to /boot/grub2/themes/Mirage
  become: true
  copy:
    src: /usr/share/grub/themes/Mirage
    dest: /boot/grub2/themes/Mirage
    remote_src: true

- name: Optimize the GRUB resolution
  become: true
  lineinfile:
    path: /etc/default/grub
    regex: "GRUB_GFXMODE="
    line: "GRUB_GFXMODE={{ qubes_grub_gfxmode }},auto"
  notify: update grub

- name: Ensure GRUB_GFXPAYLOAD_LINUX is set
  become: true
  lineinfile:
    path: /etc/default/grub
    regex: "GRUB_GFXPAYLOAD_LINUX="
    line: 'GRUB_GFXPAYLOAD_LINUX="keep"'
  notify: update grub

- name: Ensure GRUB is using the Mirage theme
  become: true
  lineinfile:
    path: /etc/default/grub
    regex: "GRUB_THEME="
    line: 'GRUB_THEME="/boot/grub2/themes/Mirage/theme.txt"'
  notify: update grub
