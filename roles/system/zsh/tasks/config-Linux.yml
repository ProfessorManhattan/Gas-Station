---
- name: Ensure .zshrc is copied to the User's home directory
  become_user: "{{ user.username }}"
  copy:
    src: /root/.zshrc
    dest: "~/.zshrc"
    mode: 0644
    owner: "{{ user.username }}"
    group: "{{ user.groupname | default(omit) }}"
    remote_src: true
  when: ansible_system == 'Linux'

- name: Ensure plugins are configured
  become_user: "{{ user.username }}"
  blockinfile:
    path: ~/.zshrc
    marker: "#{mark} ANSIBLE MANAGED BLOCK for ohmyzsh"
    insertafter: '^plugins=\('
    block: |
      plugins=(
      {% for item in omz_plugins %}
        {{ item }}
      {% endfor %}
      )
    backup: true

- name: Ensure Theme is configured
  become_user: "{{ user.username }}"
  lineinfile:
    path: ~/.zshrc
    regexp: "^ZSH_THEME="
    line: '{{ ''ZSH_THEME="'' + omz_theme + ''"'' }}'
    backup: true

- name: Ensure zsh-autocomplete directory exists
  become_user: "{{ user.username }}"
  file:
    dest: ~/.local/share/zsh-autocomplete
    state: directory
    mode: 0700

- name: Ensure zsh-autocomplete is cloned and up-to-date
  become_user: "{{ user.username }}"
  git:
    repo: 'https://github.com/marlonrichert/zsh-autocomplete.git'
    dest: ~/.local/share/zsh-autocomplete
    version: main
    depth: 1

- name: Ensure zsh-autocomplete configuration is added
  become_user: "{{ user.username }}"
  lineinfile:
    path: ~/.zshrc
    line: 'source ~/Git/zsh-autocomplete/zsh-autocomplete.plugin.zsh'
    insertbefore: BOF
    backup: true
    create: true
    mode: 0700

- name: Ensure compinit settings are commented out
  become_user: "{{ user.username }}"
  replace:
    path: ~/.zshrc
    regexp: '(^.*compinit.*$)'
    replace: '# \1'
    backup: true

- name: Ensure zsh-autocomplete configuration is added to Ubuntu
  become_user: "{{ user.username }}"
  lineinfile:
    path: ~/.zshenv
    line: 'skip_global_compinit=1'
    backup: true
    create: true
    mode: 0700
  when: ansible_distribution == 'Ubuntu'
