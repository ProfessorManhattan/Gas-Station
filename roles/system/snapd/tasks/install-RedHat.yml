---
- name: Ensure snapd is present
  dnf:
    name: snapd
    state: present
    enablerepo: epel
    update_cache: "{{ omit if skip_package_cache_update is defined else 'true' }}"
  register: snapd

- name: Ensure snap dependencies are installed
  dnf:
    name: '{{ snap_dependencies }}'
    state: present

- name: Enable and start the snapd systemd unit
  systemd:
    name: snapd.socket
    state: started
    enabled: true
  when: not ("'WSLENV' in ansible_env or 'microsoft' in ansible_kernel or 'WSL' in ansible_kernel")

- name: Create a link to enable classic snap support
  file:
    src: /var/lib/snapd/snap
    dest: /snap
    state: link

- name: Restart systemd-udevd # noqa 503
  systemd:
    name: systemd-udevd
    state: restarted
  when:
    - snapd.changed
    - not ("'WSLENV' in ansible_env or 'microsoft' in ansible_kernel or 'WSL' in ansible_kernel")

- name: Restart snapd.seeded.service # noqa 503
  systemd:
    name: snapd.seeded.service
    state: restarted
  when:
    - snapd.changed
    - not ("'WSLENV' in ansible_env or 'microsoft' in ansible_kernel or 'WSL' in ansible_kernel")

- name: Ensure snap core is installed
  community.general.snap:
    name: core
    state: present
